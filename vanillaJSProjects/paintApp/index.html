<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Paint App</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      
      * {
        box-sizing: border-box;
      }
      
      :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --dark-gradient: linear-gradient(135deg, #434343 0%, #000000 100%);
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        --shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);
        --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
        --primary-color: #667eea;
        --text-dark: #2c3e50;
        --text-light: #ffffff;
        --border-radius: 16px;
        --border-radius-small: 8px;
      }
      
      body {
        margin: 0;
        padding: 20px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        background-attachment: fixed;
        min-height: 100vh;
        position: relative;
      }
      
      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: url('data:image/svg+xml,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><g fill="%23ffffff" fill-opacity="0.05"><circle cx="30" cy="30" r="2"/></g></svg>');
        pointer-events: none;
        z-index: -1;
      }
      
      .app-container {
        max-width: 100vw;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-heavy);
        overflow: hidden;
        animation: slideUp 0.6s ease-out;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .top-nav {
        background: var(--primary-gradient);
        color: var(--text-light);
        padding: 8px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      
      .app-logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.2rem;
        font-weight: 700;
      }
      
      .top-nav-tools {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .nav-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 6px;
        color: white;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }
      
      .nav-btn.active {
        background: rgba(255, 255, 255, 0.4);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
      }
      
      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      .sidebar {
        width: 280px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-right: 1px solid rgba(255, 255, 255, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow-y: auto;
        z-index: 999;
      }
      
      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }
      
      .sidebar-toggle {
        position: absolute;
        right: -12px;
        top: 20px;
        width: 24px;
        height: 40px;
        background: var(--primary-gradient);
        border: none;
        border-radius: 0 6px 6px 0;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 1001;
      }
      
      .sidebar-toggle:hover {
        width: 28px;
      }
      
      .sidebar-content {
        padding: 20px 15px;
        position: relative;
      }
      
      .tool-group {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
      }
      
      .tool-group:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
      }
      
      .tool-group h3 {
        margin: 0 0 12px 0;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-dark);
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      
      .controls-row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        align-items: center;
      }
      
      .canvas-workspace {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fafafa;
        position: relative;
      }
      
      input[type="color"] {
        width: 70px;
        height: 50px;
        border: 3px solid #fff;
        border-radius: var(--border-radius-small);
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
      }
      
      input[type="color"]:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      }
      
      input[type="range"] {
        flex: 1;
        min-width: 120px;
        height: 6px;
        background: linear-gradient(to right, #e0e0e0, var(--primary-color));
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
      }
      
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-gradient);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
      }
      
      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
      }
      
      select {
        padding: 10px 16px;
        border: 2px solid #e9ecef;
        border-radius: var(--border-radius-small);
        background: white;
        color: var(--text-dark);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
      }
      
      select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .btn {
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        text-align: center;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        min-width: 60px;
        justify-content: center;
        white-space: nowrap;
      }
      
      .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: all 0.5s;
      }
      
      .btn:hover::before {
        left: 100%;
      }
      
      .btn-primary {
        background: var(--primary-gradient);
        color: white;
      }
      
      .btn-secondary {
        background: var(--dark-gradient);
        color: white;
      }
      
      .btn-success {
        background: var(--success-gradient);
        color: white;
      }
      
      .btn-danger {
        background: var(--danger-gradient);
        color: white;
      }
      
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      
      .btn:active {
        transform: translateY(0);
      }
      
      .btn.active {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        50% { box-shadow: 0 8px 35px rgba(102, 126, 234, 0.6); }
      }
      
      .color-palette {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        gap: 8px;
        margin-top: 16px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: var(--border-radius-small);
        backdrop-filter: blur(5px);
      }
      
      .color-swatch {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid rgba(255, 255, 255, 0.8);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      
      .color-swatch::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 50%;
        padding: 2px;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.8));
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask-composite: subtract;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .color-swatch:hover {
        transform: scale(1.15);
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
      }
      
      .color-swatch:hover::before {
        opacity: 1;
      }
      
      .canvas-container {
        position: relative;
        margin: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        overflow: hidden;
        background: white;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        flex: 1;
      }
      
      #canvas {
        display: block;
        cursor: crosshair;
        transition: all 0.2s ease;
      }
      
      .brush-preview {
        position: fixed;
        pointer-events: none;
        border-radius: 50%;
        border: 2px solid var(--primary-color);
        background: rgba(102, 126, 234, 0.2);
        opacity: 0.8;
        z-index: 1000;
        display: none;
        transition: all 0.1s ease;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
      }
      
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 20px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-dark);
      }
      
      .status-bar > div {
        background: rgba(255, 255, 255, 0.7);
        padding: 4px 12px;
        border-radius: 15px;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      
      .coordinates {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-weight: 600;
      }
      
      @media (max-width: 768px) {
        body {
          padding: 5px;
        }
        
        .sidebar {
          width: 260px;
        }
        
        .sidebar.collapsed {
          width: 0;
        }
        
        .top-nav {
          padding: 6px 10px;
        }
        
        .nav-btn {
          padding: 4px 8px;
          font-size: 0.7rem;
        }
        
        .canvas-container {
          margin: 10px;
        }
        
        .app-logo {
          font-size: 1rem;
        }
        
        .btn {
          min-width: 50px;
          padding: 4px 8px;
          font-size: 0.7rem;
        }
        
        .tool-group {
          padding: 10px;
          margin-bottom: 10px;
        }
        
        .sidebar-content {
          padding: 15px 10px;
        }
      }
      
      .hidden {
        display: none !important;
      }
      
      .shape-preview {
        position: absolute;
        border: 2px dashed var(--primary-color);
        background: rgba(102, 126, 234, 0.1);
        pointer-events: none;
        display: none;
        border-radius: 2px;
        animation: dashMove 1s linear infinite;
      }
      
      @keyframes dashMove {
        to {
          stroke-dashoffset: -20;
        }
      }
      
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      
      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb {
        background: var(--primary-gradient);
        border-radius: 4px;
      }
      
      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6b4b9a 100%);
      }
      
      /* Loading animation */
      .loading {
        opacity: 0;
        animation: fadeIn 0.5s ease-in-out forwards;
      }
      
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      
      /* Glassmorphism effect for inputs */
      input[type="file"] + .btn {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: var(--text-dark);
      }
      
      /* Enhanced focus states */
      .btn:focus-visible {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }
      
      /* Tooltip styles */
      .btn[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border-radius: 4px;
        font-size: 0.8rem;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Top Navigation -->
      <div class="top-nav">
        <div class="app-logo">
          üé® Paint Studio
        </div>
        <div class="top-nav-tools">
          <button class="nav-btn active" data-tool="brush" title="Brush (B)">üñåÔ∏è</button>
          <button class="nav-btn" data-tool="eraser" title="Eraser (E)">üßπ</button>
          <button class="nav-btn" data-tool="fill" title="Fill (F)">ü™£</button>
          <button class="nav-btn" data-tool="eyedropper" title="Eyedropper (I)">üíß</button>
          <button class="nav-btn" data-tool="line" title="Line">üìè</button>
          <button class="nav-btn" data-tool="rectangle" title="Rectangle">‚¨ú</button>
          <button class="nav-btn" data-tool="circle" title="Circle">‚≠ï</button>
          <button class="nav-btn" id="clearCanvas" title="Clear Canvas">üóëÔ∏è</button>
          <button class="nav-btn" id="undo" title="Undo (Ctrl+Z)">‚Ü∂</button>
          <button class="nav-btn" id="redo" title="Redo (Ctrl+Y)">‚Ü∑</button>
          <button class="nav-btn" id="download" title="Save">üíæ</button>
        </div>
      </div>
      
      <!-- Main Content Area -->
      <div class="main-content">
        <!-- Collapsible Sidebar -->
        <div class="sidebar" id="sidebar">
          <button class="sidebar-toggle" id="sidebarToggle">‚óÄ</button>
          <div class="sidebar-content">
            <!-- Colors -->
            <div class="tool-group">
              <h3>üé® Colors</h3>
              <div class="controls-row" style="flex-direction: column; gap: 8px;">
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input id="color" type="color" value="#000000" title="Primary Color" style="width: 40px; height: 30px;" />
                  <input id="bgColor" type="color" value="#ffffff" title="Background Color" style="width: 40px; height: 30px;" />
                </div>
                <div style="display: flex; align-items: center; gap: 6px; width: 100%;">
                  <label style="font-size: 0.75rem; color: #495057;">Opacity:</label>
                  <input id="opacity" type="range" min="0.1" max="1" value="1" step="0.1" style="flex: 1;" />
                  <span id="opacityValue" style="font-size: 0.75rem; color: #495057; min-width: 35px;">100%</span>
                </div>
              </div>
              <div class="color-palette" id="colorPalette" style="grid-template-columns: repeat(8, 1fr); gap: 4px; margin-top: 8px;"></div>
            </div>
            
            <!-- Brush Settings -->
            <div class="tool-group">
              <h3>üñåÔ∏è Brush</h3>
              <div class="controls-row" style="flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 6px; width: 100%;">
                  <label style="font-size: 0.75rem; color: #495057;">Size:</label>
                  <input id="size" type="range" min="1" max="100" value="10" style="flex: 1;" />
                  <span id="sizeValue" style="font-size: 0.75rem; color: #495057; min-width: 35px;">10px</span>
                </div>
                <select id="brushShape" style="width: 100%; font-size: 0.75rem;">
                  <option value="round">‚óè Round</option>
                  <option value="square">‚ñ† Square</option>
                  <option value="spray">üí´ Spray</option>
                </select>
              </div>
            </div>
            
            <!-- Special Effects -->
            <div class="tool-group">
              <h3>‚ú® Effects</h3>
              <div class="controls-row">
                <button class="btn btn-secondary" id="symmetryMode" title="Mirror Drawing Mode">ü™û</button>
                <button class="btn btn-secondary" id="rainbowMode" title="Rainbow Color Mode">üåà</button>
                <button class="btn btn-secondary" id="gridToggle" title="Toggle Grid Overlay">üìê</button>
              </div>
            </div>
            
            <!-- File Operations -->
            <div class="tool-group">
              <h3>üìÅ Files</h3>
              <div class="controls-row" style="flex-direction: column; gap: 6px;">
                <input type="file" id="loadImage" accept="image/*" class="hidden" />
                <button class="btn btn-primary" onclick="document.getElementById('loadImage').click()" title="Load Image" style="width: 100%;">üìÅ Load</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Canvas Workspace -->
        <div class="canvas-workspace">
          <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="shape-preview" id="shapePreview"></div>
          </div>
        </div>
      </div>
      
      <div class="status-bar">
        <div class="coordinates">Position: <span id="coordinates">0, 0</span></div>
        <div>Canvas: <span id="canvasSize">800 x 600</span></div>
        <div>Tool: <span id="currentTool">Brush</span></div>
      </div>
    </div>
    
    <div class="brush-preview" id="brushPreview"></div>
    <script>
      // Get DOM elements
      const canvas = document.querySelector("#canvas");
      const canvasContainer = document.querySelector(".canvas-container");
      const ctx = canvas.getContext("2d");
      const brushPreview = document.getElementById("brushPreview");
      const shapePreview = document.getElementById("shapePreview");
      
      // Controls
      const colorInput = document.getElementById("color");
      const bgColorInput = document.getElementById("bgColor");
      const sizeInput = document.getElementById("size");
      const opacityInput = document.getElementById("opacity");
      const brushShapeSelect = document.getElementById("brushShape");
      const toolButtons = document.querySelectorAll("[data-tool]");
      
      // Status elements
      const coordinatesSpan = document.getElementById("coordinates");
      const canvasSizeSpan = document.getElementById("canvasSize");
      const currentToolSpan = document.getElementById("currentTool");
      const sizeValueSpan = document.getElementById("sizeValue");
      const opacityValueSpan = document.getElementById("opacityValue");
      
      // State variables
      let isDrawing = false;
      let currentTool = "brush";
      let lastX = 0;
      let lastY = 0;
      let startX = 0;
      let startY = 0;
      let undoStack = [];
      let redoStack = [];
      let isSymmetryMode = false;
      let isRainbowMode = false;
      let rainbowHue = 0;
      let isGridVisible = false;
      
      // Color palette
      const colors = [
        "#000000", "#FFFFFF", "#FF0000", "#00FF00", "#0000FF", 
        "#FFFF00", "#FF00FF", "#00FFFF", "#FFA500", "#800080",
        "#FFC0CB", "#A52A2A", "#808080", "#000080", "#008000",
        "#FF6347", "#4B0082", "#FFD700", "#32CD32", "#FF1493"
      ];
      
      // Initialize canvas
      function initCanvas() {
        canvas.width = 800;
        canvas.height = 600;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        updateCanvasSize();
        saveState();
      }
      
      // Update canvas size display
      function updateCanvasSize() {
        canvasSizeSpan.textContent = `${canvas.width} x ${canvas.height}`;
      }
      
      // Save canvas state for undo/redo
      function saveState() {
        undoStack.push(canvas.toDataURL());
        if (undoStack.length > 50) undoStack.shift();
        redoStack = [];
      }
      
      // Create color palette
      function createColorPalette() {
        const palette = document.getElementById("colorPalette");
        colors.forEach(color => {
          const swatch = document.createElement("div");
          swatch.className = "color-swatch";
          swatch.style.backgroundColor = color;
          swatch.addEventListener("click", () => {
            colorInput.value = color;
            updateBrushSettings();
          });
          palette.appendChild(swatch);
        });
      }
      
      // Update brush settings
      function updateBrushSettings() {
        const color = colorInput.value;
        const size = parseInt(sizeInput.value);
        const opacity = parseFloat(opacityInput.value);
        
        ctx.globalAlpha = opacity;
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = size;
        
        sizeValueSpan.textContent = `${size}px`;
        opacityValueSpan.textContent = `${Math.round(opacity * 100)}%`;
        
        updateBrushPreview();
      }
      
      // Update brush preview
      function updateBrushPreview() {
        const size = parseInt(sizeInput.value);
        brushPreview.style.width = `${size}px`;
        brushPreview.style.height = `${size}px`;
        brushPreview.style.backgroundColor = colorInput.value;
        brushPreview.style.opacity = opacityInput.value;
      }
      
      // Tool selection
      function selectTool(tool) {
        currentTool = tool;
        currentToolSpan.textContent = tool.charAt(0).toUpperCase() + tool.slice(1);
        
        // Update all tool buttons (both nav and sidebar)
        const allToolButtons = document.querySelectorAll("[data-tool]");
        allToolButtons.forEach(btn => {
          if (btn.dataset.tool === tool) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
        
        // Update cursor
        if (tool === "eyedropper") {
          canvas.style.cursor = "crosshair";
        } else if (tool === "eraser") {
          canvas.style.cursor = "grab";
        } else {
          canvas.style.cursor = "crosshair";
        }
      }
      
      // Get coordinates
      function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
      }
      
      // Get touch coordinates
      function getTouchCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      
      // Drawing functions
      function drawBrush(x, y) {
        ctx.globalCompositeOperation = "source-over";
        
        if (isRainbowMode) {
          ctx.strokeStyle = `hsl(${rainbowHue}, 100%, 50%)`;
          rainbowHue = (rainbowHue + 2) % 360;
        }
        
        const shape = brushShapeSelect.value;
        
        if (shape === "spray") {
          drawSpray(x, y);
        } else {
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
        }
        
        if (isSymmetryMode) {
          const centerX = canvas.width / 2;
          const mirrorX = centerX + (centerX - x);
          
          ctx.beginPath();
          ctx.moveTo(centerX + (centerX - lastX), lastY);
          ctx.lineTo(mirrorX, y);
          ctx.stroke();
        }
      }
      
      function drawSpray(x, y) {
        const density = 20;
        const radius = parseInt(sizeInput.value);
        
        for (let i = 0; i < density; i++) {
          const offsetX = (Math.random() - 0.5) * radius;
          const offsetY = (Math.random() - 0.5) * radius;
          
          ctx.fillRect(x + offsetX, y + offsetY, 2, 2);
          
          if (isSymmetryMode) {
            const centerX = canvas.width / 2;
            const mirrorX = centerX + (centerX - x);
            ctx.fillRect(mirrorX + offsetX, y + offsetY, 2, 2);
          }
        }
      }
      
      function drawEraser(x, y) {
        ctx.globalCompositeOperation = "destination-out";
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
      }
      
      function drawLine(startX, startY, endX, endY) {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      }
      
      function drawRectangle(startX, startY, endX, endY) {
        const width = endX - startX;
        const height = endY - startY;
        ctx.strokeRect(startX, startY, width, height);
      }
      
      function drawCircle(startX, startY, endX, endY) {
        const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
      }
      
      function drawTriangle(startX, startY, endX, endY) {
        const width = endX - startX;
        const height = endY - startY;
        
        ctx.beginPath();
        ctx.moveTo(startX + width / 2, startY);
        ctx.lineTo(startX, endY);
        ctx.lineTo(endX, endY);
        ctx.closePath();
        ctx.stroke();
      }
      
      function floodFill(startX, startY, fillColor) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const startIndex = (startY * canvas.width + startX) * 4;
        const startR = data[startIndex];
        const startG = data[startIndex + 1];
        const startB = data[startIndex + 2];
        const startA = data[startIndex + 3];
        
        const fillR = parseInt(fillColor.substr(1, 2), 16);
        const fillG = parseInt(fillColor.substr(3, 2), 16);
        const fillB = parseInt(fillColor.substr(5, 2), 16);
        
        if (startR === fillR && startG === fillG && startB === fillB) return;
        
        const stack = [[startX, startY]];
        
        while (stack.length > 0) {
          const [x, y] = stack.pop();
          const index = (y * canvas.width + x) * 4;
          
          if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
          if (data[index] !== startR || data[index + 1] !== startG || 
              data[index + 2] !== startB || data[index + 3] !== startA) continue;
          
          data[index] = fillR;
          data[index + 1] = fillG;
          data[index + 2] = fillB;
          data[index + 3] = 255;
          
          stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
        
        ctx.putImageData(imageData, 0, 0);
      }
      
      function eyedropper(x, y) {
        const imageData = ctx.getImageData(x, y, 1, 1);
        const data = imageData.data;
        const r = data[0];
        const g = data[1];
        const b = data[2];
        
        const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        colorInput.value = hex;
        updateBrushSettings();
      }
      
      // Grid functions
      function drawGrid() {
        if (!isGridVisible) return;
        
        ctx.save();
        ctx.strokeStyle = "#ddd";
        ctx.lineWidth = 1;
        ctx.globalAlpha = 0.5;
        
        for (let x = 0; x <= canvas.width; x += 20) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, canvas.height);
          ctx.stroke();
        }
        
        for (let y = 0; y <= canvas.height; y += 20) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(canvas.width, y);
          ctx.stroke();
        }
        
        ctx.restore();
      }
      
      // Event handlers
      function handleMouseDown(e) {
        if (e.button !== 0) return; // Only left click
        
        isDrawing = true;
        const coords = getCoordinates(e);
        startX = lastX = coords.x;
        startY = lastY = coords.y;
        
        if (currentTool === "eyedropper") {
          eyedropper(coords.x, coords.y);
          return;
        }
        
        if (currentTool === "fill") {
          saveState();
          floodFill(Math.floor(coords.x), Math.floor(coords.y), colorInput.value);
          return;
        }
        
        if (currentTool === "brush" || currentTool === "eraser") {
          saveState();
        }
      }
      
      function handleMouseMove(e) {
        const coords = getCoordinates(e);
        coordinatesSpan.textContent = `${Math.round(coords.x)}, ${Math.round(coords.y)}`;
        
        // Update brush preview position
        brushPreview.style.left = `${e.clientX - parseInt(sizeInput.value) / 2}px`;
        brushPreview.style.top = `${e.clientY - parseInt(sizeInput.value) / 2}px`;
        
        if (!isDrawing) return;
        
        if (currentTool === "brush") {
          drawBrush(coords.x, coords.y);
        } else if (currentTool === "eraser") {
          drawEraser(coords.x, coords.y);
        } else if (["line", "rectangle", "circle", "triangle"].includes(currentTool)) {
          // Show shape preview
          updateShapePreview(startX, startY, coords.x, coords.y);
        }
        
        lastX = coords.x;
        lastY = coords.y;
      }
      
      function handleMouseUp(e) {
        if (!isDrawing) return;
        isDrawing = false;
        
        const coords = getCoordinates(e);
        
        if (["line", "rectangle", "circle", "triangle"].includes(currentTool)) {
          saveState();
          ctx.globalCompositeOperation = "source-over";
          
          if (currentTool === "line") drawLine(startX, startY, coords.x, coords.y);
          else if (currentTool === "rectangle") drawRectangle(startX, startY, coords.x, coords.y);
          else if (currentTool === "circle") drawCircle(startX, startY, coords.x, coords.y);
          else if (currentTool === "triangle") drawTriangle(startX, startY, coords.x, coords.y);
          
          hideShapePreview();
        }
        
        if (isGridVisible) drawGrid();
      }
      
      function updateShapePreview(startX, startY, endX, endY) {
        const left = Math.min(startX, endX);
        const top = Math.min(startY, endY);
        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);
        
        shapePreview.style.display = "block";
        shapePreview.style.left = `${left}px`;
        shapePreview.style.top = `${top}px`;
        shapePreview.style.width = `${width}px`;
        shapePreview.style.height = `${height}px`;
        
        if (currentTool === "circle") {
          shapePreview.style.borderRadius = "50%";
        } else {
          shapePreview.style.borderRadius = "0";
        }
      }
      
      function hideShapePreview() {
        shapePreview.style.display = "none";
      }
      
      // Touch events
      function handleTouchStart(e) {
        e.preventDefault();
        const coords = getTouchCoordinates(e);
        isDrawing = true;
        startX = lastX = coords.x;
        startY = lastY = coords.y;
        
        if (currentTool === "brush" || currentTool === "eraser") {
          saveState();
        }
      }
      
      function handleTouchMove(e) {
        e.preventDefault();
        if (!isDrawing) return;
        
        const coords = getTouchCoordinates(e);
        
        if (currentTool === "brush") {
          drawBrush(coords.x, coords.y);
        } else if (currentTool === "eraser") {
          drawEraser(coords.x, coords.y);
        }
        
        lastX = coords.x;
        lastY = coords.y;
      }
      
      function handleTouchEnd(e) {
        e.preventDefault();
        isDrawing = false;
        if (isGridVisible) drawGrid();
      }
      
      // Button event handlers
      document.getElementById("clearCanvas").addEventListener("click", () => {
        if (confirm("Are you sure you want to clear the canvas?")) {
          saveState();
          ctx.fillStyle = bgColorInput.value;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          if (isGridVisible) drawGrid();
        }
      });
      
      document.getElementById("undo").addEventListener("click", () => {
        if (undoStack.length > 1) {
          redoStack.push(undoStack.pop());
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            if (isGridVisible) drawGrid();
          };
          img.src = undoStack[undoStack.length - 1];
        }
      });
      
      document.getElementById("redo").addEventListener("click", () => {
        if (redoStack.length > 0) {
          const state = redoStack.pop();
          undoStack.push(state);
          const img = new Image();
          img.onload = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            if (isGridVisible) drawGrid();
          };
          img.src = state;
        }
      });
      
      document.getElementById("download").addEventListener("click", () => {
        const link = document.createElement("a");
        link.download = `painting-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
      });
      
      document.getElementById("loadImage").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              saveState();
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              ctx.fillStyle = "#FFFFFF";
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              if (isGridVisible) drawGrid();
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById("symmetryMode").addEventListener("click", (e) => {
        isSymmetryMode = !isSymmetryMode;
        e.target.classList.toggle("active");
      });
      
      document.getElementById("rainbowMode").addEventListener("click", (e) => {
        isRainbowMode = !isRainbowMode;
        e.target.classList.toggle("active");
      });
      
      document.getElementById("gridToggle").addEventListener("click", (e) => {
        isGridVisible = !isGridVisible;
        e.target.classList.toggle("active");
        if (isGridVisible) {
          drawGrid();
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const img = new Image();
          img.onload = () => ctx.drawImage(img, 0, 0);
          img.src = undoStack[undoStack.length - 1];
        }
      });
      
      // Background color change
      bgColorInput.addEventListener("change", () => {
        saveState();
        ctx.fillStyle = bgColorInput.value;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (isGridVisible) drawGrid();
      });
      
      // Tool selection - handle both sidebar and nav buttons
      const allToolButtons = document.querySelectorAll("[data-tool]");
      allToolButtons.forEach(btn => {
        btn.addEventListener("click", () => selectTool(btn.dataset.tool));
      });
      
      // Sidebar toggle functionality
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      
      sidebarToggle.addEventListener("click", () => {
        sidebar.classList.toggle("collapsed");
        sidebarToggle.textContent = sidebar.classList.contains("collapsed") ? "‚ñ∂" : "‚óÄ";
      });
      
      // Input event listeners
      [colorInput, sizeInput, opacityInput, brushShapeSelect].forEach(input => {
        input.addEventListener("input", updateBrushSettings);
        input.addEventListener("change", updateBrushSettings);
      });
      
      // Mouse events
      canvas.addEventListener("mousedown", handleMouseDown);
      canvas.addEventListener("mousemove", handleMouseMove);
      canvas.addEventListener("mouseup", handleMouseUp);
      canvas.addEventListener("mouseout", () => {
        isDrawing = false;
        brushPreview.style.display = "none";
        hideShapePreview();
      });
      
      canvas.addEventListener("mouseenter", () => {
        brushPreview.style.display = "block";
      });
      
      // Touch events
      canvas.addEventListener("touchstart", handleTouchStart);
      canvas.addEventListener("touchmove", handleTouchMove);
      canvas.addEventListener("touchend", handleTouchEnd);
      
      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "z" && !e.shiftKey) {
          e.preventDefault();
          document.getElementById("undo").click();
        } else if ((e.ctrlKey && e.shiftKey && e.key === "Z") || (e.ctrlKey && e.key === "y")) {
          e.preventDefault();
          document.getElementById("redo").click();
        } else if (e.key === "b" || e.key === "B") {
          selectTool("brush");
        } else if (e.key === "e" || e.key === "E") {
          selectTool("eraser");
        } else if (e.key === "f" || e.key === "F") {
          selectTool("fill");
        } else if (e.key === "i" || e.key === "I") {
          selectTool("eyedropper");
        }
      });
      
      // Initialize everything
      initCanvas();
      createColorPalette();
      updateBrushSettings();
      selectTool("brush");
      
      // Prevent context menu on canvas
      canvas.addEventListener("contextmenu", (e) => e.preventDefault());
    </script>
  </body>
</html>
